<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOESIS · Editor</title>
  <meta name="description" content="Noesis editor – write atomic ideas in Markdown, link them into a graph, and evolve them over time.">
  <meta name="author" content="Anish kushwaha">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Markdown parser + syntax highlighting (frontend only) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <style>
    /* ---------- PREMIUM DARK THEME · GOLD ACCENTS · BASED ON HOME PAGE ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0C0F14;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(200, 170, 100, 0.05) 0px, transparent 20%),
        radial-gradient(circle at 90% 70%, rgba(180, 150, 80, 0.04) 0px, transparent 25%),
        linear-gradient(145deg, rgba(20, 25, 33, 0.3) 0%, rgba(8, 10, 14, 0.8) 100%),
        repeating-linear-gradient(45deg, rgba(200, 180, 120, 0.02) 0px, rgba(200, 180, 120, 0.02) 1px,
                                  transparent 1px, transparent 12px);
      color: #F0F3F7;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      font-weight: 350;
      line-height: 1.7;
      letter-spacing: 0.01em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 2.2rem 1.8rem;
    }

    body::before {
      content: '';
      position: fixed;
      top: -10vh;
      left: -10vw;
      width: 50vw;
      height: 50vh;
      background: radial-gradient(circle at center, rgba(200, 175, 100, 0.08), transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      bottom: -10vh;
      right: -10vw;
      width: 60vw;
      height: 60vh;
      background: radial-gradient(circle at center, rgba(140, 170, 200, 0.05), transparent 75%);
      pointer-events: none;
      z-index: 0;
    }

    .page-container {
      max-width: 1280px;
      width: 100%;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(2px);
    }

    /* ---------- HEADER – NOESIS IDENTITY ---------- */
    .identity-header {
      text-align: center;
      margin-bottom: 2.9rem;
      position: relative;
    }

    .identity-header h1 {
      font-size: 4.5rem;
      font-weight: 650;
      letter-spacing: 12px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #FFFFFF 0%, #F3E9D2 60%, #D4B48C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.2rem;
      line-height: 1;
      text-shadow: 0 2px 10px rgba(212, 180, 140, 0.3);
      animation: fadeGlow 2s ease-out;
    }

    @keyframes fadeGlow {
      0% { opacity: 0.8; text-shadow: 0 0 0 rgba(212,180,140,0); }
      100% { opacity: 1; text-shadow: 0 2px 20px rgba(212,180,140,0.3); }
    }

    .os-tagline {
      font-size: 1.0rem;
      font-weight: 280;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #D8C9AA;
      background: rgba(12, 16, 22, 0.6);
      display: inline-block;
      padding: 0.4rem 1.8rem;
      border: 1px solid rgba(212, 180, 140, 0.3);
      backdrop-filter: blur(4px);
      margin-top: 0.2rem;
      border-radius: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    /* ---------- NAVIGATION (top + bottom, same as home) ---------- */
    nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.3rem 2.4rem;
      padding: 1.2rem 0;
      border-top: 1px solid rgba(212, 180, 140, 0.25);
      border-bottom: 1px solid rgba(212, 180, 140, 0.2);
      margin-bottom: 2.2rem;
      background: rgba(8, 10, 14, 0.35);
      backdrop-filter: blur(8px);
      border-radius: 2px;
    }

    .nav-bottom {
      margin-top: 2rem;
      margin-bottom: 0.8rem;
      border-top: 1px solid rgba(212, 180, 140, 0.18);
      border-bottom: none;
      padding-top: 1.2rem;
      padding-bottom: 0.4rem;
      background: transparent;
      backdrop-filter: none;
    }

    nav a {
      color: #E7DFD1;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 550;
      letter-spacing: 3px;
      text-transform: uppercase;
      padding: 0.4rem 0.2rem;
      border-bottom: 1.5px solid transparent;
      transition: border-bottom 0.25s ease, color 0.2s, text-shadow 0.2s;
      position: relative;
    }

    .nav-bottom a {
      font-size: 0.75rem;
      letter-spacing: 2.5px;
      font-weight: 500;
      color: #C9BCA5;
    }

    nav a:hover {
      color: #FFF9EC;
      border-bottom: 1.5px solid #D8B78C;
      text-shadow: 0 0 6px rgba(216, 183, 140, 0.5);
    }

    nav a[href="editor.html"] {
      color: #FFFAF0;
      border-bottom: 1.5px solid #C8A87C;
    }

    /* ---------- MAIN LAYOUT: EDITOR ---------- */
    main {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .editor-shell {
      background: rgba(18, 22, 30, 0.7);
      border: 1px solid rgba(200, 175, 120, 0.25);
      box-shadow: 0 20px 40px -15px rgba(0,0,0,0.7);
      padding: 1.4rem 1.6rem 1.2rem;
    }

    .editor-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .editor-title-group {
      flex: 1;
      min-width: 220px;
    }

    .editor-title-input {
      width: 100%;
      padding: 0.6rem 0.8rem;
      background: rgba(5, 7, 11, 0.9);
      border: 1px solid rgba(200, 175, 120, 0.4);
      color: #F5EEE3;
      font-size: 1.05rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      border-radius: 0px;
    }

    .editor-title-input::placeholder {
      color: #8F8373;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: #CBB89D;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .meta-pill {
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(200, 175, 120, 0.4);
      background: rgba(10, 12, 16, 0.9);
    }

    .editor-controls-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .select-compact, .tag-input, .change-reason-input {
      background: rgba(5, 7, 11, 0.9);
      border: 1px solid rgba(150, 125, 90, 0.7);
      color: #F5EEE3;
      font-size: 0.8rem;
      padding: 0.35rem 0.6rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      border-radius: 0;
    }

    .select-compact option {
      color: #111827;
    }

    .tag-input {
      min-width: 160px;
    }

    .change-reason-input {
      min-width: 220px;
    }

    .status-indicator {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #F3E3C8;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(200, 175, 120, 0.6);
      background: rgba(20, 24, 32, 0.8);
    }

    .status-indicator.modified {
      border-color: #FACC6B;
      color: #FACC6B;
    }

    .status-indicator.saved {
      border-color: #4ADE80;
      color: #BBF7D0;
    }

    /* toolbar */
    .editor-toolbar {
      margin-top: 1rem;
      padding: 0.6rem 0.8rem;
      border-top: 1px solid rgba(200, 175, 120, 0.35);
      border-bottom: 1px solid rgba(200, 175, 120, 0.2);
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: center;
    }

    .toolbar-btn {
      background: rgba(5, 7, 11, 0.9);
      border: 1px solid rgba(150, 125, 90, 0.7);
      color: #E9DFCF;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1.8px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      border-radius: 0;
    }

    .toolbar-btn:hover {
      background: rgba(200, 168, 120, 0.1);
      border-color: #E5CDA8;
    }

    .toolbar-spacer {
      flex: 1;
    }

    .toolbar-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #C5B79D;
    }

    /* editor + preview layout */
    .editor-main-layout {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 1rem;
      min-height: 320px;
    }

    @media (max-width: 900px) {
      .editor-main-layout {
        grid-template-columns: 1fr;
      }
    }

    .editor-pane, .preview-pane {
      background: rgba(7, 9, 14, 0.95);
      border: 1px solid rgba(120, 100, 70, 0.7);
      padding: 0.8rem;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .pane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #CBB89D;
    }

    .pane-label {
      color: #E7DFD1;
    }

    .pane-meta {
      font-size: 0.7rem;
      color: #AFA08A;
    }

    .markdown-textarea {
      flex: 1;
      width: 100%;
      resize: none;
      border: none;
      outline: none;
      background: transparent;
      color: #F3EADF;
      font-family: "JetBrains Mono", "SF Mono", Menlo, Monaco, Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      padding: 0.3rem 0;
      overflow-y: auto;
    }

    .markdown-textarea::placeholder {
      color: #6E6253;
    }

    .preview-content {
      flex: 1;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.7;
      color: #E5E1D8;
    }

    .preview-content h1, .preview-content h2, .preview-content h3,
    .preview-content h4, .preview-content h5, .preview-content h6 {
      margin-top: 0.6rem;
      margin-bottom: 0.3rem;
      color: #F8E7CF;
    }

    .preview-content pre {
      background: #020617;
      padding: 0.6rem 0.8rem;
      overflow-x: auto;
      border-radius: 0;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .preview-content code {
      background: rgba(15, 23, 42, 0.9);
      padding: 0.1rem 0.25rem;
      border-radius: 3px;
      font-size: 0.85rem;
    }

    .preview-content a {
      color: #93C5FD;
    }

    .preview-content ul, .preview-content ol {
      padding-left: 1.2rem;
    }

    /* side panel: outline + history + analytics */
    .side-panel {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .side-panel {
        grid-template-columns: 1fr;
      }
    }

    .panel-card {
      background: rgba(10, 12, 18, 0.85);
      border: 1px solid rgba(120, 100, 70, 0.8);
      padding: 0.8rem 0.9rem;
      font-size: 0.8rem;
    }

    .panel-header {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #D6C9B4;
      margin-bottom: 0.4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body {
      max-height: 180px;
      overflow-y: auto;
      color: #E3DBCF;
    }

    .outline-item {
      padding: 0.18rem 0;
      cursor: pointer;
    }

    .outline-item small {
      color: #A89B87;
    }

    .history-item {
      padding: 0.18rem 0.2rem;
      border-bottom: 1px solid rgba(75, 85, 99, 0.6);
      cursor: pointer;
    }

    .history-item:hover {
      background: rgba(55, 65, 81, 0.4);
    }

    .analytics-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.25rem;
    }

    .analytics-pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(156, 163, 175, 0.6);
      font-size: 0.75rem;
      color: #E5E7EB;
    }

    /* floating save button (mobile) */
    .floating-save {
      position: fixed;
      right: 1.4rem;
      bottom: 1.4rem;
      background: #C8A87C;
      color: #020617;
      border: none;
      border-radius: 999px;
      padding: 0.7rem 1.4rem;
      font-size: 0.85rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      box-shadow: 0 15px 25px rgba(0,0,0,0.6);
      cursor: pointer;
      display: none;
      z-index: 20;
    }

    @media (max-width: 768px) {
      .floating-save { display: inline-flex; }
    }

    /* FOOTER */
    footer {
      margin-top: 1.5rem;
      padding: 1.2rem 0.5rem 0.7rem;
      text-align: center;
      font-size: 0.8rem;
      color: #AD9F8D;
      text-transform: uppercase;
      letter-spacing: 4px;
      border-top: 1px solid rgba(180, 150, 110, 0.25);
    }

    footer span {
      font-weight: 400;
      color: #DAC29E;
    }

    /* small utility */
    .link-subtle {
      font-size: 0.75rem;
      color: #9CA3AF;
      text-decoration: underline;
      cursor: pointer;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #E5E7EB;
    }
  </style>
</head>
<body>
<div class="page-container">

  <!-- HEADER -->
  <header class="identity-header">
    <h1>NOESIS</h1>
    <div class="os-tagline">A Personal Knowledge Operating System · Editor</div>
  </header>

  <!-- TOP NAVIGATION -->
  <nav class="nav-top">
    <a href="index.html">HOME</a>
    <a href="editor.html">EDITOR</a>
    <a href="graph.html">GRAPH</a>
    <a href="ideas.html">IDEAS</a>
    <a href="creator.html">CREATOR</a>
  </nav>

  <main>
    <!-- EDITOR SHELL -->
    <div class="editor-shell" id="editor-shell">

      <!-- Title + metadata -->
      <div class="editor-header-row">
        <div class="editor-title-group">
          <input id="note-title" class="editor-title-input" type="text" placeholder="Title of this idea · question · definition">
          <div class="meta-row">
            <div class="meta-pill">ID: <span id="note-id-display">auto</span></div>
            <div class="meta-pill">Created: <span id="created-at-display">—</span></div>
            <div class="meta-pill">Last modified: <span id="updated-at-display">—</span></div>
          </div>
        </div>
        <div class="editor-controls-group">
          <select id="note-type" class="select-compact" title="Note type">
            <option value="idea">Idea</option>
            <option value="question">Question</option>
            <option value="definition">Definition</option>
          </select>
          <select id="note-domain" class="select-compact" title="Domain">
            <option value="default">Domain · Default</option>
            <option value="philosophy">Philosophy</option>
            <option value="technology">Technology</option>
            <option value="systems">Systems</option>
            <option value="personal">Personal</option>
          </select>
          <input id="note-tags" class="tag-input" type="text" placeholder="tags: graph, identity, etc.">
          <span id="status-indicator" class="status-indicator">Draft</span>
        </div>
      </div>

      <!-- change reason + quick actions row -->
      <div class="editor-header-row" style="margin-top:0.5rem;">
        <input id="change-reason" class="change-reason-input" type="text" placeholder="Change reason (required for updates)">
        <div class="editor-controls-group">
          <button id="btn-save" class="toolbar-btn">Save</button>
          <button id="btn-clear" class="toolbar-btn">Clear draft</button>
          <button id="btn-export" class="toolbar-btn">Export .md</button>
          <button id="btn-copy" class="toolbar-btn">Copy as Markdown</button>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="editor-toolbar">
        <button class="toolbar-btn" data-md="**bold**" data-shortcut="Ctrl+B">Bold</button>
        <button class="toolbar-btn" data-md="*italic*" data-shortcut="Ctrl+I">Italic</button>
        <button class="toolbar-btn" data-md="`code`" data-shortcut="Ctrl+E">Code</button>
        <button class="toolbar-btn" data-md="> quote">Quote</button>
        <button class="toolbar-btn" data-md="# Heading 1">H1</button>
        <button class="toolbar-btn" data-md="## Heading 2">H2</button>
        <button class="toolbar-btn" data-md="```language\ncode\n```">Code block</button>
        <button class="toolbar-btn" data-md="- [ ] task">Checklist</button>
        <button class="toolbar-btn" data-md="---">Rule</button>
        <button class="toolbar-btn" data-md="[text](url)">Link</button>
        <button class="toolbar-btn" data-md="[^1]: footnote">Footnote</button>
        <span class="toolbar-spacer"></span>
        <span class="toolbar-label">
          <span id="char-count">0</span> chars ·
          <span id="word-count">0</span> words ·
          ≈ <span id="read-time">0</span> min
        </span>
      </div>

      <!-- Editor + preview -->
      <div class="editor-main-layout">
        <!-- Editor pane -->
        <div class="editor-pane">
          <div class="pane-header">
            <span class="pane-label">Markdown</span>
            <span class="pane-meta">
              <span class="badge" id="session-time">0:00</span>
              <span class="badge" id="session-words">0 words this session</span>
            </span>
          </div>
          <textarea id="markdown-input" class="markdown-textarea" placeholder="# Start with one idea per note"></textarea>
        </div>

        <!-- Preview pane -->
        <div class="preview-pane" id="preview-pane">
          <div class="pane-header">
            <span class="pane-label">Preview</span>
            <span class="pane-meta">
              <span class="badge" id="connectivity-count">0 links</span>
              <span class="badge">Live</span>
            </span>
          </div>
          <div id="markdown-preview" class="preview-content"></div>
        </div>
      </div>

      <!-- Side panels: outline + history + search / links / analytics -->
      <div class="side-panel">
        <!-- Outline + linking -->
        <div class="panel-card">
          <div class="panel-header">
            <span>Outline & links</span>
            <span class="link-subtle" id="btn-jump-top">Jump to top</span>
          </div>
          <div class="panel-body" id="outline-panel"></div>
          <hr style="border:0;border-top:1px solid rgba(55,65,81,0.6);margin:0.6rem 0;">
          <div class="panel-header">
            <span>Internal links</span>
            <span class="link-subtle" id="btn-open-linked">Open linked note</span>
          </div>
          <div style="margin-bottom:0.4rem;">
            <input id="internal-link-search" class="select-compact" style="width:100%;" placeholder="Search notes to link">
          </div>
          <div class="panel-body" id="links-panel">
            <p style="font-size:0.75rem;color:#9CA3AF;">
              Type a title above to search existing notes in this browser. Click a result to insert an internal link.
            </p>
          </div>
        </div>

        <!-- History + analytics -->
        <div class="panel-card">
          <div class="panel-header">
            <span>Versions & history</span>
            <span class="link-subtle" id="btn-show-diff">Compare last versions</span>
          </div>
          <div class="panel-body" id="history-panel"></div>
          <hr style="border:0;border-top:1px solid rgba(55,65,81,0.6);margin:0.6rem 0;">
          <div class="panel-header">
            <span>Session analytics</span>
            <span class="link-subtle" id="btn-graph-preview">Graph preview</span>
          </div>
          <div class="analytics-row">
            <div class="analytics-pill">Total revisions: <span id="total-revisions">0</span></div>
            <div class="analytics-pill">Recent links: <span id="recent-links-count">0</span></div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- BOTTOM NAVIGATION -->
  <nav class="nav-bottom">
    <a href="index.html">HOME</a>
    <a href="editor.html">EDITOR</a>
    <a href="graph.html">GRAPH</a>
    <a href="ideas.html">IDEAS</a>
    <a href="creator.html">CREATOR</a>
  </nav>

  <!-- FOOTER -->
  <footer>
    <span>© 2026 Anish Kushwaha • All rights reserved</span>
    <span> ⚚Ⓐ⚚ </span>)
  </footer>

</div>

<!-- Floating quick save (mobile) -->
<button class="floating-save" id="floating-save">Save</button>

<script>
(function () {
  "use strict";

  const API_BASE = "https://noesis-psi.vercel.app";
  const STORAGE_KEY_CURRENT = "noesis-current-note";
  const STORAGE_KEY_NOTES = "noesis-notes";
  const STORAGE_KEY_HISTORY = "noesis-history";

  const titleInput = document.getElementById("note-title");
  const typeSelect = document.getElementById("note-type");
  const domainSelect = document.getElementById("note-domain");
  const tagsInput = document.getElementById("note-tags");
  const changeReasonInput = document.getElementById("change-reason");
  const statusIndicator = document.getElementById("status-indicator");

  const markdownInput = document.getElementById("markdown-input");
  const previewEl = document.getElementById("markdown-preview");
  const outlinePanel = document.getElementById("outline-panel");
  const linksPanel = document.getElementById("links-panel");
  const historyPanel = document.getElementById("history-panel");

  const noteIdDisplay = document.getElementById("note-id-display");
  const createdDisplay = document.getElementById("created-at-display");
  const updatedDisplay = document.getElementById("updated-at-display");

  const charCountEl = document.getElementById("char-count");
  const wordCountEl = document.getElementById("word-count");
  const readTimeEl = document.getElementById("read-time");
  const connectivityCountEl = document.getElementById("connectivity-count");
  const totalRevisionsEl = document.getElementById("total-revisions");
  const recentLinksCountEl = document.getElementById("recent-links-count");
  const sessionTimeEl = document.getElementById("session-time");
  const sessionWordsEl = document.getElementById("session-words");

  const btnSave = document.getElementById("btn-save");
  const btnClear = document.getElementById("btn-clear");
  const btnExport = document.getElementById("btn-export");
  const btnCopy = document.getElementById("btn-copy");
  const btnJumpTop = document.getElementById("btn-jump-top");
  const btnOpenLinked = document.getElementById("btn-open-linked");
  const floatingSave = document.getElementById("floating-save");
  const internalLinkSearch = document.getElementById("internal-link-search");
  const btnGraphPreview = document.getElementById("btn-graph-preview");

  let note = null;
  let sessionStart = Date.now();
  let sessionWords = 0;
  let sessionTimerId = null;
  let isDirty = false;

  // ---------- Markdown + preview setup ----------
  marked.setOptions({
    breaks: true,
    highlight: function (code, lang) {
      try {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      } catch {
        return code;
      }
    }
  });

  function newNote() {
    const now = new Date().toISOString();
    const id = "note-" + Date.now().toString(36);

    return {
      id,
      title: "",
      markdown: "",
      type: "idea",
      domain: "default",
      tags: [],
      createdAt: now,
      updatedAt: now,
      status: "draft",
      revisions: 0
    };
  }

  function loadCurrentNote() {
    const raw = localStorage.getItem(STORAGE_KEY_CURRENT);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function persistCurrentNote() {
    if (!note) return;
    localStorage.setItem(STORAGE_KEY_CURRENT, JSON.stringify(note));
  }

  function saveToNotesCollection() {
    const existingRaw = localStorage.getItem(STORAGE_KEY_NOTES);
    let list = [];
    if (existingRaw) {
      try { list = JSON.parse(existingRaw) || []; } catch {}
    }
    const idx = list.findIndex(n => n.id === note.id);
    if (idx >= 0) list[idx] = note;
    else list.push(note);
    localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(list));
    return list;
  }

  function pushHistoryEntry(reason) {
    const historyRaw = localStorage.getItem(STORAGE_KEY_HISTORY);
    let history = [];
    if (historyRaw) {
      try { history = JSON.parse(historyRaw) || []; } catch {}
    }
    history.push({
      noteId: note.id,
      timestamp: new Date().toISOString(),
      reason: reason || "manual",
      title: note.title,
      markdown: note.markdown
    });
    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
  }

  function renderHistoryPanel() {
    const historyRaw = localStorage.getItem(STORAGE_KEY_HISTORY);
    let history = [];
    if (historyRaw) {
      try { history = JSON.parse(historyRaw) || []; } catch {}
    }
    const noteHistory = history.filter(h => h.noteId === note.id).slice(-20).reverse();
    totalRevisionsEl.textContent = noteHistory.length.toString();
    historyPanel.innerHTML = "";
    if (noteHistory.length === 0) {
      historyPanel.innerHTML = "<p style='font-size:0.75rem;color:#9CA3AF;'>No versions stored yet.</p>";
      return;
    }
    noteHistory.forEach(entry => {
      const div = document.createElement("div");
      div.className = "history-item";
      div.textContent = new Date(entry.timestamp).toLocaleString() + " — " + (entry.reason || "manual");
      div.addEventListener("click", () => {
        if (!confirm("Replace current content with this stored version?")) return;
        markdownInput.value = entry.markdown;
        titleInput.value = entry.title || "";
        syncFromInputs(true);
      });
      historyPanel.appendChild(div);
    });
  }

  function renderOutline() {
    const text = markdownInput.value;
    const lines = text.split(/
?
/);
    const headings = [];
    lines.forEach((line, index) => {
      const m = /^(#{1,6})\s+(.*)/.exec(line);
      if (m) {
        const level = m[1].length;
        const title = m[2].trim();
        headings.push({ line: index, level, title });
      }
    });

    outlinePanel.innerHTML = "";
    if (headings.length === 0) {
      outlinePanel.innerHTML = "<p style='font-size:0.75rem;color:#9CA3AF;'>No headings yet. Use #, ##, ### to create structure.</p>";
      return;
    }
    headings.forEach(h => {
      const div = document.createElement("div");
      div.className = "outline-item";
      div.style.paddingLeft = (h.level - 1) * 0.8 + "rem";
      div.innerHTML = "<strong>" + h.title + "</strong> <small>#" + h.level + "</small>";
      div.addEventListener("click", () => {
        const pos = getLineStartPosition(markdownInput, h.line);
        markdownInput.focus();
        markdownInput.setSelectionRange(pos, pos);
      });
      outlinePanel.appendChild(div);
    });
  }

  function getLineStartPosition(textarea, lineIndex) {
    const value = textarea.value;
    const lines = value.split(/
?
/);
    let pos = 0;
    for (let i = 0; i < lineIndex && i < lines.length; i++) {
      pos += lines[i].length + 1;
    }
    return pos;
  }

  function countWords(text) {
    const m = text.trim().match(/\S+/g);
    return m ? m.length : 0;
  }

  function updateStatsAndPreview() {
    const text = markdownInput.value;
    const chars = text.length;
    const words = countWords(text);
    const minutes = Math.max(1, Math.ceil(words / 200));

    charCountEl.textContent = chars.toString();
    wordCountEl.textContent = words.toString();
    readTimeEl.textContent = minutes.toString();

    // session words = words typed since initial load (rough)
    sessionWords = words;
    sessionWordsEl.textContent = sessionWords + " words this session";

    const html = marked.parse(text || "");
    previewEl.innerHTML = html;
    previewEl.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));

    // simple link count
    const internalLinks = (text.match(/\[\[.*?\]\]/g) || []).length;
const markdownLinks = (text.match(/\[.*?\]\(.*?\)/g) || []).length;
const links = internalLinks + markdownLinks;
    connectivityCountEl.textContent = links + " links";

    renderOutline();
    updateStatus("modified");
    isDirty = true;
  }

  function updateStatus(state) {
    statusIndicator.classList.remove("modified", "saved");
    if (state === "modified") {
      statusIndicator.textContent = "Modified";
      statusIndicator.classList.add("modified");
    } else if (state === "saved") {
      statusIndicator.textContent = "Saved";
      statusIndicator.classList.add("saved");
    } else {
      statusIndicator.textContent = "Draft";
    }
  }

  function syncFromInputs(skipPreview) {
    if (!note) note = newNote();
    note.title = titleInput.value.trim();
    note.type = typeSelect.value;
    note.domain = domainSelect.value;
    note.tags = tagsInput.value.split(",").map(t => t.trim()).filter(Boolean);
    note.markdown = markdownInput.value;
    note.updatedAt = new Date().toISOString();

    noteIdDisplay.textContent = note.id;
    createdDisplay.textContent = new Date(note.createdAt).toLocaleString();
    updatedDisplay.textContent = new Date(note.updatedAt).toLocaleString();

    persistCurrentNote();
    if (!skipPreview) updateStatsAndPreview();
  }

  function loadFromNoteObject(n) {
    note = n;
    titleInput.value = n.title || "";
    typeSelect.value = n.type || "idea";
    domainSelect.value = n.domain || "default";
    tagsInput.value = (n.tags || []).join(", ");
    markdownInput.value = n.markdown || "";
    noteIdDisplay.textContent = n.id;
    createdDisplay.textContent = n.createdAt ? new Date(n.createdAt).toLocaleString() : "—";
    updatedDisplay.textContent = n.updatedAt ? new Date(n.updatedAt).toLocaleString() : "—";
    updateStatsAndPreview();
    renderHistoryPanel();
  }

  function saveNote(reason) {
    if (!note) note = newNote();

    if (note.markdown === "" && titleInput.value.trim() === "") {
      alert("Nothing to save yet.");
      return;
    }

    if (note.revisions > 0 && !changeReasonInput.value.trim()) {
      alert("Provide a change reason before updating an existing note.");
      changeReasonInput.focus();
      return;
    }

    syncFromInputs(true);
    note.revisions += 1;
    const reasonText = changeReasonInput.value.trim() || reason || "manual";
    pushHistoryEntry(reasonText);
    saveToNotesCollection();
    renderHistoryPanel();
    updateStatsAndPreview();
    isDirty = false;
    updateStatus("saved");

    // call backend (stateless)
    fetch(API_BASE + "/api/notes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: note.id,
        title: note.title,
        markdown: note.markdown,
        links: [], // frontend can compute real links later
        domain: note.domain
      })
    }).catch(() => {});

    changeReasonInput.value = "";
  }

  function clearDraft() {
    if (!confirm("Clear current draft? This does not delete saved versions.")) return;
    markdownInput.value = "";
    titleInput.value = "";
    changeReasonInput.value = "";
    syncFromInputs();
  }

  function exportMarkdown() {
    const blob = new Blob([markdownInput.value], { type: "text/markdown;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = (note.title || note.id || "noesis-note") + ".md";
    a.click();
    URL.revokeObjectURL(url);
  }

  function copyMarkdown() {
    navigator.clipboard.writeText(markdownInput.value || "").then(() => {
      alert("Markdown copied to clipboard.");
    }).catch(() => {
      alert("Could not copy to clipboard.");
    });
  }

  function handleToolbarClick(ev) {
    const btn = ev.target.closest(".toolbar-btn");
    if (!btn || !btn.dataset.md) return;
    const snippet = btn.dataset.md;
    insertMarkdownSnippet(snippet);
  }

  function insertMarkdownSnippet(snippet) {
    const el = markdownInput;
    const start = el.selectionStart || 0;
    const end = el.selectionEnd || 0;
    const value = el.value;
    const before = value.slice(0, start);
    const after = value.slice(end);

    el.value = before + snippet + after;
    const cursor = before.length + snippet.length;
    el.focus();
    el.setSelectionRange(cursor, cursor);
    syncFromInputs();
  }

  function handleKeydown(ev) {
    if (ev.ctrlKey || ev.metaKey) {
      const key = ev.key.toLowerCase();
      if (key === "s") {
        ev.preventDefault();
        saveNote("shortcut Ctrl+S");
      } else if (key === "b") {
        ev.preventDefault();
        insertMarkdownSnippet("**bold**");
      } else if (key === "i") {
        ev.preventDefault();
        insertMarkdownSnippet("*italic*");
      } else if (key === "e") {
        ev.preventDefault();
        insertMarkdownSnippet("`code`");
      }
    }
  }

  function startSessionTimer() {
    if (sessionTimerId) clearInterval(sessionTimerId);
    sessionTimerId = setInterval(() => {
      const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      sessionTimeEl.textContent =
        mins.toString() + ":" + (secs < 10 ? "0" + secs : secs.toString());
    }, 1000);
  }

  function updateInternalLinksPanel() {
    const allRaw = localStorage.getItem(STORAGE_KEY_NOTES);
    let allNotes = [];
    if (allRaw) {
      try { allNotes = JSON.parse(allRaw) || []; } catch {}
    }
    const q = (internalLinkSearch.value || "").toLowerCase();
    linksPanel.innerHTML = "";
    const candidates = allNotes.filter(n =>
      n.id !== note.id &&
      ((n.title || "").toLowerCase().includes(q) || (n.id || "").toLowerCase().includes(q))
    ).slice(0, 20);

    if (candidates.length === 0) {
      linksPanel.innerHTML = "<p style='font-size:0.75rem;color:#9CA3AF;'>No matching notes found.</p>";
      return;
    }

    candidates.forEach(n => {
      const div = document.createElement("div");
      div.className = "history-item";
      div.textContent = (n.title || "(untitled)") + " · " + n.id;
      div.addEventListener("click", () => {
        const linkText = "[[" + (n.title || n.id) + "]]";
        insertMarkdownSnippet(linkText);
        recentLinksCountEl.textContent =
          (parseInt(recentLinksCountEl.textContent || "0", 10) + 1).toString();
      });
      linksPanel.appendChild(div);
    });
  }

  function handleGraphPreview() {
    const allRaw = localStorage.getItem(STORAGE_KEY_NOTES);
    let notesForGraph = [];
    if (allRaw) {
      try { notesForGraph = JSON.parse(allRaw) || []; } catch {}
    }
    fetch(API_BASE + "/api/graph", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ notes: notesForGraph })
    }).then(res => res.json()).then(data => {
      console.log("Graph preview data:", data.graph);
      alert("Graph preview computed in console. Open Graph page to visualize.");
    }).catch(() => {
      alert("Could not contact backend graph API. Graph will still work locally when implemented.");
    });
  }

  function beforeUnloadHandler(ev) {
    if (isDirty) {
      ev.preventDefault();
      ev.returnValue = "";
      return "";
    }
  }

  // ---------- Initialization ----------
  document.addEventListener("DOMContentLoaded", () => {
    const existing = loadCurrentNote();
    if (existing) {
      loadFromNoteObject(existing);
    } else {
      note = newNote();
      loadFromNoteObject(note);
    }

    startSessionTimer();

    markdownInput.addEventListener("input", () => {
      syncFromInputs();
    });

    titleInput.addEventListener("input", () => syncFromInputs());
    typeSelect.addEventListener("change", () => syncFromInputs());
    domainSelect.addEventListener("change", () => syncFromInputs());
    tagsInput.addEventListener("input", () => syncFromInputs());

    document.querySelector(".editor-toolbar").addEventListener("click", handleToolbarClick);
    document.addEventListener("keydown", handleKeydown);

    btnSave.addEventListener("click", () => saveNote("manual save button"));
    floatingSave.addEventListener("click", () => saveNote("floating save"));
    btnClear.addEventListener("click", clearDraft);
    btnExport.addEventListener("click", exportMarkdown);
    btnCopy.addEventListener("click", copyMarkdown);
    btnJumpTop.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    internalLinkSearch.addEventListener("input", updateInternalLinksPanel);
    btnGraphPreview.addEventListener("click", handleGraphPreview);

    window.addEventListener("beforeunload", beforeUnloadHandler);
    btnOpenLinked.addEventListener("click", openLinkedNoteAtCursor);
    // simple backend health check
    fetch(API_BASE + "/api/health").catch(() => {});
  });
src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js">

function openLinkedNoteAtCursor() {
  const text = markdownInput.value;
  const cursorPos = markdownInput.selectionStart;

  // Find all internal links
  const regex = /\[\[([^\]]+?)\]\]/g;
  let match;
  let foundTitle = null;

  while ((match = regex.exec(text)) !== null) {
    const start = match.index;
    const end = start + match[0].length;

    if (cursorPos >= start && cursorPos <= end) {
      foundTitle = match[1].trim();
      break;
    }
  }

  if (!foundTitle) {
    alert("Place the cursor inside an internal link like [[Note Title]]");
    return;
  }

  const allRaw = localStorage.getItem(STORAGE_KEY_NOTES);
  let allNotes = [];
  if (allRaw) {
    try { allNotes = JSON.parse(allRaw) || []; } catch {}
  }

  const target = allNotes.find(n =>
    (n.title || "").toLowerCase() === foundTitle.toLowerCase()
  );

  if (!target) {
    alert("No saved note found with title: " + foundTitle);
    return;
  }

  if (isDirty) {
    const confirmSwitch = confirm("You have unsaved changes. Continue?");
    if (!confirmSwitch) return;
  }

  loadFromNoteObject(target);
  window.scrollTo({ top: 0, behavior: "smooth" });
}
</script>
</body>
  </html>
